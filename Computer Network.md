# Computer Network

## OSI 和 TCP/IP 网络分层模型

### OSI 七层模型

> OSI(Open System Interconnect Reference Model)七层模型是一个通信协议的分层模型
>
> 1. **物理层（Physical Layer）**：负责在物理媒介（如电缆、光纤等）上传输原始的比特流，提供物理连接和电气特性等功能。
>
>    传输数据类型：比特流（0和1）。
>
>    传输介质：物理媒介，如双绞线、同轴电缆、光纤等。
>
> 2. **数据链路层（Data Link Layer）**：负责将原始的比特流转换成逻辑上的数据帧，并提供错误检测和纠正等功能，保证数据的可靠传输。
>
>    传输数据类型：数据帧。
>
>    传输介质：物理媒介，如双绞线、同轴电缆、光纤等。
>
> 3. **网络层（Network Layer）**：负责对数据进行分组和路由以及寻址，使数据能够在不同的网络之间传输。
>
>    传输数据类型：数据包（Packet）。
>
>    传输介质：网络，如互联网等。
>
> 4. **传输层（Transport Layer）**：负责提供端到端的可靠传输，并通过端口号将数据传递给应用层。
>
>    传输数据类型：报文（Message）。
>
>    传输介质：网络，如TCP/IP协议。
>
> 5. **会话层（Session Layer）**：负责建立、维护和结束通信会话，管理会话中的会话层协议。
>
>    传输数据类型：会话数据（Session Data）。
>
>    传输介质：网络。
>
> 6. **表示层（Presentation Layer）**：负责数据的编码、加密、压缩和格式转换等，使数据能够被应用层正确地解释和处理。
>
>    传输数据类型：表示数据（Presentation Data）。
>
>    传输介质：网络。
>
> 7. **应用层（Application Layer）**：负责提供应用程序所需的各种服务和功能，如文件传输、电子邮件、远程登录等。
>
>    传输数据类型：应用数据（Application Data）。
>
>    传输介质：网络。



![image-20230325003322570](https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230325003322570.png)

![image-20230325003519848](https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230325003519848.png)

![image-20230325004040805](https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230325004040805.png)

### TCP/IP四层模型（Main-Stream）

> TCP/IP协议栈是一个分层的网络通信模型，包含四个层次：应用层、传输层、网络层和数据链路层
>
> - **应用层**
>
>   传输的数据类型：应用层传输的数据通常是用户数据，例如Web页面、电子邮件、文件传输等。
>
>   作用：应用层为应用程序提供了接口，使它们能够与网络通信，例如HTTP、FTP、SMTP等协议都是应用层协议，负责在网络上传输数据。
>
>   传输介质：应用层使用各种协议和端口进行通信，常见的协议有HTTP、FTP、SMTP等。
>
> - **传输层**
>
>   传输的数据类型：传输层传输的数据通常是端到端的数据流，可以是TCP或UDP数据包。
>
>   作用：传输层为应用程序提供了端到端的数据传输服务，同时也为网络层提供了可靠的数据传输。
>
>   传输介质：传输层使用IP地址和端口号来识别不同的应用程序，可以在IP层之上使用多种传输介质，例如以太网、WLAN、蓝牙等。
>
> - **网络层**
>
>   传输的数据类型：网络层传输的数据通常是IP数据包。
>
>   作用：网络层将数据包从源地址传输到目标地址，同时还提供了路由、拥塞控制等功能。
>
>   传输介质：网络层使用IP地址来标识不同的主机和路由器，可以在数据链路层之上使用多种传输介质，例如以太网、WLAN、蓝牙等。
>
> - **数据链路层**
>
>   传输的数据类型：数据链路层传输的数据通常是帧或包，例如以太网帧、无线局域网数据包等。
>
>   作用：数据链路层负责在物理层之上建立和管理数据链路，包括帧同步、流量控制等功能。
>
>   传输介质：数据链路层使用MAC地址来标识不同的网络设备，可以使用多种传输介质，例如以太网、WLAN、蓝牙等。

![image-20230325004439878](https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230325004439878.png)

![image-20230325004530094](https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230325004530094.png)

![image-20230325230913397](https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230325230913397.png)

## HTTP

> HTTP（HyperText Transfer Protocol），是一种**应用层协议**，用于在**客户端和服务器之间进行通信**，常用于 Web 应用中。HTTP 协议基于 TCP/IP 协议族，**通过 TCP 连接在客户端和服务器之间进行数据传输**。**通过请求和响应的交换达成通信**。
>
> - 简单性：HTTP 协议设计简单，易于实现和理解。
> - 可扩展性：HTTP 协议支持多种数据类型，可以扩展新的数据类型和请求方法。
> - 无状态：HTTP 协议是一种无状态协议，即每个请求和响应之间是相互独立的，服务器不会保存客户端的状态信息。
> - 基于请求-响应模型：HTTP 协议是基于请求-响应模型的，客户端向服务器发送请求，服务器返回响应。
> - 支持缓存：HTTP 协议支持缓存机制，客户端可以缓存服务器返回的数据，减少网络传输的数据量和延迟。
> - 支持代理：HTTP 协议支持代理服务器，可以缓存和过滤请求和响应。
> - 支持管线化：HTTP 协议支持管线化技术，可以在一个 TCP 连接上同时发送多个请求和响应。
> - 支持安全性：HTTP 协议引入了 HTTPS（HyperText Transfer Protocol Secure）协议，通过 SSL/TLS 加密技术保证数据的安全性。
> - 支持身份认证：HTTP 协议支持身份认证机制，包括基本认证、摘要认证和 OAuth 等。
> - 支持重定向：HTTP 协议支持重定向机制，可以将请求重定向到其他 URL。
> - 支持多媒体：HTTP 协议支持多种媒体类型，包括 HTML、CSS、JavaScript、图片、音频和视频等。
> - 支持国际化：HTTP 协议支持国际化，可以在请求头中指定语言和字符集。

### 请求-响应模型

> HTTP 协议是基于**请求-响应模型**的，客户端向服务器发送请求，服务器返回响应。
>
> 1. **客户端向服务器发送请求**，请求消息包括**请求行、请求头和请求体**。请求行包括请求方法、请求资源的 URL 和 HTTP 协议版本。请求头包括请求的一些附加信息，如浏览器类型、请求的数据类型等。请求体通常用于 POST 请求中，表示客户端要提交的数据。
> 2. **服务器收到请求后，进行处理，并且返回响应**，响应消息包括**响应行、响应头和响应体**。响应行包括 HTTP  协议版本、状态码和状态描述。状态码用于表示请求的处理结果，如 200 表示请求成功，404  表示请求的资源不存在等。响应头和请求头类似，包括响应的一些附加信息，如服务器类型、响应的数据类型等。响应体通常是服务器返回的数据，如 HTML  页面、图片等。
>
> HTTP 请求和响应的交互流程如下：
>
> 1. 客户端向服务器发送请求，包括请求行、请求头和请求体。
> 2. 服务器接收到请求后，根据请求中的信息进行处理，并生成响应。
> 3. 服务器将响应发送给客户端，包括状态行、响应头和响应体。
> 4. 客户端接收到响应后，根据响应中的信息进行处理，如显示 HTML 页面、解析 JSON 数据等。

![image-20230405143741295](https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230405143741295.png)

### HTTP Message

> HTTP（HyperText Transfer Protocol）是一种基于请求-响应模型的协议，客户端向服务器发送请求，服务器返回响应。HTTP 请求和响应的基本结构如下：
>
> **HTTP 请求：**
>
> - 请求行：包括请求方法、请求的 URL 和 HTTP 协议的版本号。
> - 请求头：包括一些附加的信息，如客户端的浏览器类型、请求的 MIME 类型等。
> - 请求体：包括请求中的数据，如表单数据、JSON 数据等。在 GET 请求中，请求体通常为空。
>
> **HTTP 响应：**
>
> - 状态行：包括 HTTP 协议的版本号、状态码和状态描述。
> - 响应头：包括一些附加的信息，如服务器类型、响应的 MIME 类型等。
> - 响应体：包括服务器返回的数据，如 HTML 页面、JSON 数据等。

![image-20230405144500366](https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230405144500366.png)

### 无状态

> HTTP（HyperText Transfer Protocol）是一种无状态协议，也就是说，每个请求和响应之间是相互独立的，服务器不会保存客户端的状态信息。这意味着服务器不会记住之前的请求或响应，也不会跟踪客户端的会话状态。
>
> 这种无状态的设计使得 HTTP 协议具有很好的可扩展性和灵活性，同时也带来了一些问题，如：
>
> 1. 无法跟踪会话状态：由于服务器不会跟踪客户端的会话状态，因此无法确保在多个请求之间保持一致的状态。
> 2. 需要频繁地传输相同的信息：由于每个请求和响应都是独立的，因此需要频繁地传输相同的信息，如用户的身份认证信息等。
>
> 为了解决这些问题，Web 应用程序通常使用一些技术来维护会话状态，如**使用 cookie 或将会话状态存储在服务器**上的数据库中。这样可以在多个请求之间共享状态信息，使得 Web 应用程序更加方便和实用。

![image-20230405150742634](https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230405150742634.png)

#### 使用 Cookie 的状态管理

> HTTP（HyperText Transfer Protocol）是一种无状态协议，也就是说，每个请求和响应之间是相互独立的，服务器不会保存客户端的状态信息。这意味着服务器不会记住之前的请求或响应，也不会跟踪客户端的会话状态。
>
> **使用 cookie 或将会话状态存储在服务器**上的数据库中。这样可以在多个请求之间共享状态信息，使得 Web 应用程序更加方便和实用。
>
> Cookie 技术通过在请求和响应报文中写入 Cookie 信息来控制客户端的状态。

![image-20230405152019759](https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230405152019759.png)

![image-20230405152035312](https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230405152035312.png)

![image-20230405152041791](https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230405152041791.png)

### HTTP 的方法

> HTTP 协议定义了多种方法用于对服务器资源进行操作，常用的方法包括：
>
> - GET：用于请求指定的页面或资源，通常用于获取数据。
> - POST：用于提交数据到服务器，通常用于提交表单数据。
> - PUT：用于上传文件到服务器，或者更新指定的资源。
> - DELETE：用于删除指定的资源。
> - HEAD：与 GET 方法类似，但只返回响应头，不返回响应体。
> - OPTIONS：（预检请求）用于查询服务器支持的方法和其他一些信息。
> - CONNECT：用于建立与目标资源的网络连接，通常用于 HTTPS 请求。
> - TRACE：用于返回服务器收到的请求，通常用于测试和诊断。

### HTTP 的状态码

> HTTP 协议定义了多种状态码，用于表示请求的处理结果。常见的状态码包括：
>
> - 1xx：信息提示，表示服务器已经接收到请求，但需要进一步处理才能完成。
> - 2xx：成功，表示请求已经成功处理。
> - 3xx：重定向，表示需要客户端进一步操作才能完成请求。
> - 4xx：客户端错误，表示客户端发送的请求存在错误。
> - 5xx：服务器错误，表示服务器在处理请求时发生了错误。

### HTTP 的安全性和加密（HTTPS）

> 由于 HTTP 协议传输的数据是明文的，容易被窃听和篡改，为了保证数据的安全性，HTTP 协议引入了加密和身份认证技术。
>
> **HTTP 主要有这些不足：**
>
> - 通信使用明文（不加密），内容可能会被窃听
>
> - 不验证通信方的身份，因此有可能遭遇伪装
> - 无法证明报文的完整性，所以有可能已遭篡改
>
> **解决方案：**
>
> - 加密：HTTPS（HyperText Transfer Protocol Secure）是基于 HTTP 协议的安全版本，通过 SSL/TLS

#### HTTPS

> HTTPS（HyperText Transfer Protocol Secure）是一种**安全的 HTTP 协议**，它**在 HTTP 协议的基础上添加了 SSL/TLS 加密**，用于保护网络通信安全。
>
> **HTTP+ 加密 + 认证 + 完整性保护 =HTTPS**
>
> ![image-20230405152717714](https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230405152717714.png)
>
> **HTTPS 的工作原理：**
>
> 1. 客户端向服务器发送 HTTPS 请求。
> 2. 服务器将公钥发送给客户端。
> 3. 客户端使用服务器的公钥来加密会话密钥（session key），并将加密后的会话密钥发送给服务器。
> 4. 服务器使用私钥来解密客户端发送的会话密钥。
> 5. 服务器和客户端使用会话密钥来进行加密通信。
>
> **HTTPS 的优点：**
>
> 1. 数据加密：HTTPS 使用 SSL/TLS 加密通信，保护数据在传输过程中不被窃听或篡改。
> 2. 认证服务端：HTTPS 证书可以验证服务器的身份，防止客户端被伪造的服务器欺骗（例如钓鱼网站）。
> 3. 安全传输：HTTPS 可以通过数字证书来保证传输的数据不被篡改、重放或伪造，从而保证了通信的安全性。
> 4. 改善 SEO：搜索引擎通常会将 HTTPS 网站排名提高，从而提高了网站的搜索排名。
>
> **需要注意的是:**
>
> 1. 使用 HTTPS 会增加服务器的计算负担和网络延迟，从而可能导致性能下降。
> 2. HTTPS 的安全性也依赖于 SSL/TLS 的实现和证书的有效性，因此需要注意证书的颁发机构和有效期限，以及及时更新证书。

![image-20230405152849012](https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230405152849012.png)

![image-20230405152917243](https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230405152917243.png)

1. 客户端通过发送 Client Hello 报文开始 SSL 通信。报文中包含客户端支持的 SSL 的指定版本、加密组件（Cipher Suite）列表（所使用的加密算法及密钥长度等）。 
2. 服务器可进行 SSL 通信时，会以 Server Hello 报文作为应答。和客户端一样，在报文中包含 SSL 版本以及加密组件。服务器的加密组件内容是从接收到的客户端加密组件内筛选出来的。 
3. 之后服务器发送 Certificate 报文。报文中包含公开密钥证书。 
4. 最后服务器发送 Server Hello Done 报文通知客户端，最初阶段的 SSL 握手协商部分结束。 
5. SSL 第一次握手结束之后，客户端以 Client Key Exchange报文作为回应。报文中包含通信加密中使用的一种被称为Pre-master secret 的随机密码串。该报文已用步骤 3 中的公开密钥进行加密。 
6. 接着客户端继续发送 Change Cipher Spec 报文。该报文会提示服务器，在此报文之后的通信会采用 Pre-master secret密钥加密。 
7. 客户端发送 Finished 报文。该报文包含连接至今全部报文的整体校验值。这次握手协商是否能够成功，要以服务器是否能够正确解密该报文作为判定标准。
8. 服务器同样发送 Change Cipher Spec 报文。
9. 服务器同样发送 Finished 报文。
10. 服务器和客户端的 Finished 报文交换完毕之后，SSL 连接就算建立完成。当然，通信会受到 SSL 的保护。从此处开始进行应用层协议的通信，即发送 HTTP 请求。
11. 应用层协议通信，即发送 HTTP 响应。
12. 最后由客户端断开连接。断开连接时，发送 close_notify报文

## TCP/UDP

![image-20230405084328945](https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230405084328945.png)

> - **TCP（传输控制协议）**
>   - TCP是一种**面向连接的、可靠的**协议，它通过三次握手建立连接，保证数据传输的可靠性。TCP提供的服务包括流量控制、拥塞控制、错误校验等。TCP**通过序号和确认号来保证数据的可靠性**，同时也支持**数据的分段和重组**。
>   - **优点**是能够保证数据的**可靠**性，适合用于传输大量数据或需要保证数据完整性的应用，例如文件传输、电子邮件等。
>   - **缺点**是由于**需要建立连接和进行错误校验**等操作，会造成**一定的开销和延迟**。
> - **UDP（用户数据报协议）**
>   - UDP是一种**无连接的、不可靠**的协议，它不提供流量控制、拥塞控制和错误校验等服务。UDP数据包只包含源端口、目的端口、长度和校验和等基本信息。UDP通过尽力而为的方式进行数据传输，即发送数据后不会等待确认，也不会进行重传操作。
>   - **优点**是**传输效率高**，适合用于实时性要求高的应用，例如视频会议、实时音频等。
>   - **缺点**是**无法保证数据的可靠性**，**容易出现数据丢失、重复、乱序**等问题。
>
> ![image-20230405114202668](https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230405114202668.png)

![image-20230405113935233](https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230405113935233.png)

## TCP 传输可靠性（传输层）

> TCP通过三次握手建立连接、确认机制、序号机制、流量控制和拥塞控制等机制来保证数据传输的可靠性。
>
> TCP保障可靠性传输的方式：
>
> - **三次握手建立连接：**TCP在传输数据之前必须先建立连接，这是通过三次握手完成的。客户端首先向服务器发送一个连接请求，服务器收到请求后回复一个确认，客户端再回复一个确认。这样就建立了一个可靠的连接，可以进行数据传输。
>
> - **基于数据块传输（以段为单位）** ：应用数据被分割成 TCP 认为最适合发送的数据块，再传输给网络层，数据块被称为报文段或段。
>
> - **（序号机制）对失序数据包重新排序以及去重**：TCP 为了保证不发生丢包，就给每个包一个序列号，有了序列号能够将接收到的数据根据序列号排序，并且去掉重复序列号的数据就可以实现数据包去重。通过给每个TCP数据包进行编号来实现的，发送方会对每个数据包进行编号，接收方会对每个数据包进行确认，并指定下一个期望接收的数据包的序列号。这样可以确保数据包的顺序和完整性，避免了数据包乱序和数据丢失等问题。
>
> - **校验和** : TCP 将保持它首部和数据的检验和。这是一个端到端的检验和，目的是检测数据在传输过程中的任何变化。如果收到段的检验和有差错，TCP 将丢弃这个报文段和不确认收到此报文段。
>
> - **超时重传（确认机制）** : 当发送方发送数据之后，它启动一个定时器，等待目的端确认收到这个报文段。接收端实体对已成功收到的包发回一个相应的确认信息（ACK）。如果发送端实体在合理的往返时延（RTT）内未收到确认消息，那么对应的数据包就被假设为已丢失并进行重传。
>
> - **流量控制** : TCP 连接的每一方都有固定大小的缓冲空间，TCP 的接收端只允许发送端发送接收端缓冲区能接纳的数据。当接收方来不及处理发送方的数据，能提示发送方降低发送的速率，防止包丢失。TCP 使用的流量控制协议是可变大小的滑动窗口协议（TCP 利用滑动窗口实现流量控制）。
>
> - **拥塞控制** : 当网络拥塞时，减少数据的发送。

### 连接管理

![image-20230405122502472](https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230405122502472.png)

![image-20230405122519359](https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230405122519359.png)

### 以段为单位进行数据传输

> TCP协议以段（Segment）为单位发送消息。TCP协议**将应用层传来的数据分割成一个个的TCP段**，然后**将这些TCP段加上TCP头部信息一起发送**。TCP头部包含了序列号、确认号、窗口大小等信息，用于保证数据的可靠传输。TCP协议还会对每个TCP段进行校验和计算，以确保数据的完整性。
>
> TCP协议以段为单位发送消息的好处是可以实现可靠的数据传输。如果数据在传输过程中发生丢失、损坏或重复等情况，TCP协议可以通过重传、确认和流量控制等机制来保证数据的可靠性和顺序性。同时，TCP协议还可以根据窗口大小来控制数据的发送速率，以避免网络拥塞和丢包等问题。因此，TCP协议是一种可靠的、面向连接的协议，被广泛应用于Internet上的数据传输。

![image-20230405114744281](https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230405114744281.png)

### 序列号和确认应答机制

> - **序列号机制**
>   - 是通过给每个TCP数据包进行编号来实现的，**发送方会对每个数据包进行编号**，**接收方会对每个数据包进行确认**，**并指定下一个期望接收的数据包的序列号**。这样可以确保数据包的顺序和完整性，避免了数据包乱序和数据丢失等问题。
>
> - **确认应答机制**
>   - 是指在**接收方收到数据包后**，会**向发送方发送一个确认应答**，表示已经成功接收到数据包。发送方在收到确认应答后，会确认该数据包已经成功发送，然后再发送下一个数据包。**如果发送方没有收到确认应答**，就**会重传数据包，直到接收方发送确认为止**。

![image-20230405090638544](https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230405090638544.png)

![image-20230405090618096](https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230405090618096.png)

### 窗口控制（流控机制）

> TCP协议中的窗口控制是**一种流量控制机制**，它通过协商发送方和接收方之间的窗口大小来限制数据的发送速率，避免网络拥塞和丢包等问题。TCP协议中的窗口大小是一个动态变化的值，它根据网络延迟、丢包率和拥塞情况等因素进行调整。
>
> 通过窗口控制机制，TCP协议**可以充分利用网络带宽和容量，提高数据传输的效率**。同时，窗口控制机制还可以避免网络拥塞和丢包等问题，保证数据的可靠传输。
>
> 具体来说，发送方使用一个发送窗口来控制发送数据的速率。**发送窗口的大小由接收方通过接收窗口大小来控制**。发送方发送数据时，会将发送窗口的大小告知接收方，接收方收到数据后会向发送方发送一个确认报文，其中包含接收窗口大小。发送方根据接收窗口大小来调整发送窗口的大小，以确保数据的可靠传输和网络的效率。
>
> 
>
> 当发送方发送数据时，它会发送一个窗口大小的数据量，并等待接收方的确认。接收方会在收到数据后发送一个确认，同时告知发送方自己的窗口大小。发送方会根据接收方的窗口大小来控制发送速率，每次发送的数据量不超过接收方窗口大小的值。如果窗口大小发生变化，发送方会相应地调整发送速率。
>
> ![image-20230405121917400](https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230405121917400.png)
>
> 

![image-20230405115602340](https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230405115602340.png)

![image-20230405115634240](https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230405115634240.png)

![image-20230405115849432](https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230405115849432.png)

![image-20230405115805468](https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230405115805468.png)

### 超时重发机制

> TCP（传输控制协议）的超时重发机制是TCP实现可靠数据传输的重要机制之一。当一个TCP数据包在传输过程中发生了丢失或损坏，TCP会采取以下措施进行超时重发：
>
> 1. 发送方发送一个数据包后，会设置一个定时器，等待接收方的确认应答。如果在指定的时间内没有收到确认应答，就会认为该数据包已经丢失，发送方会重新发送该数据包。
> 2. 发送方会根据数据包的重传次数进行指数退避。每次重传后，发送方会等待更长的时间才会发送下一个数据包。这样可以避免因频繁重传而导致网络拥塞。
> 3. 发送方会根据网络的拥塞情况动态调整超时时间。如果网络拥塞，数据包传输的时间会变长，发送方就会增加超时时间，以避免过早地重传数据包。如果网络畅通，数据包传输的时间会变短，发送方就会减少超时时间，以提高数据传输的效率。
>
> ![image-20230405112702471](https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230405112702471.png)
>
> **如何判定为超时（超时时间的确定）**
>
> TCP超时重发机制中的超时时间是**根据网络延迟**和**丢包率等因素动态确定**的。
>
> TCP协议通过**维护一个计时器来检测超时事件**，并根据超时事件的发生情况调整超时时间的值。
>
> 具体来说，TCP协议**会根据历史传输数据包的RTT（Round Trip  Time，往返时间）来计算超时时间的初始值**，然后**根据实际的传输情况进行动态调整**。如果数据包在超时时间内未得到确认，TCP协议会认为数据包丢失，触发超时重传机制。如果数据包得到了确认，TCP协议会更新RTT和超时时间的值。通过这种方式，TCP协议可以动态地适应不同的网络环境，提高数据传输的效率和可靠性。

![image-20230405112623307](https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230405112623307.png)

### 窗口控制中的重发机制

> 在使用了窗口控制时:
>
> **数据已经到达接收端**；**仅仅是确认应答未能返回**的情况下**无需重发**。

![image-20230405120719379](https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230405120719379.png)

> 在使用了窗口控制时:
>
> **接收端未收到期望的序列号数据**；
>
> 1. **接收端会3次应答期望序列号的数据到发送端**，
> 2. **发送端连续3次收到同样的应答**则**认为数据段丢失**了；就会**进行重发**

![image-20230405121444207](https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230405121444207.png)

### 拥塞控制

> TCP 的阻塞控制机制主要分为两种：拥塞避免和拥塞恢复。拥塞避免用于防止网络拥塞，而拥塞恢复用于处理拥塞时的情况。
>
> **拥塞避免**
>
> 拥塞避免是 TCP 阻塞控制机制的主要部分，其目的是尽可能地利用可用的带宽，同时避免网络拥塞。
>
> 拥塞避免的最基本的方法是 TCP 的慢启动算法和拥塞避免算法。
>
> - **慢启动算法**用于在 TCP 连接开始时估计网络的拥塞程度，同时逐步增加发送窗口的大小。
>
> - **拥塞避免算法**用于在网络拥塞程度逐渐加重时，逐步减少发送窗口的大小，以避免网络拥塞。
>
> **拥塞恢复**
>
> 当网络出现拥塞时，TCP 会进入拥塞恢复状态，尝试恢复网络的正常运行。
>
> 拥塞恢复的主要机制是快速重传和快速恢复。
>
> - **快速重传**是指在 TCP 发送数据时，如果发送方没有收到相应的确认信息，则会立即重传数据。
> - **快速恢复**是指当发送方收到多个重复的确认信息时，认为网络拥塞，减少发送窗口的大小，以避免网络拥塞。

![image-20230405140028786](https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230405140028786.png)

![image-20230405140001447](https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230405140001447.png)

## TCP三次握手/四次挥手

> TCP (Transmission Control Protocol) 是一种面向连接的、可靠的、基于字节流的传输层协议。在 TCP 中，建立连接和关闭连接都需要进行握手和挥手操作。

![image-20230405090155087](https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230405090155087.png)



### **TCP 三次握手(建立连接)**

TCP 三次握手是建立 TCP 连接的过程。具体步骤如下：

1. 客户端向服务器发送 SYN (synchronize) 报文，表示请求建立连接，并且设置一个随机的初始序列号 seq，表示发送方发送的第一个数据包的序列号。
2. 服务器收到 SYN 报文后，向客户端发送 SYN-ACK (synchronize-acknowledge)  报文，表示确认客户端的请求，并且设置一个随机的初始序列号 seq，表示接收方发送的第一个数据包的序列号，同时在报文头中 ACK  标志位设置为1，表示确认客户端发送的 SYN 报文。
3. 客户端收到服务器的 SYN-ACK 报文后，向服务器发送 ACK (acknowledge) 报文，确认收到了服务器的确认，并且在报文头中 ACK 标志位设置为1，表示确认服务器发送的 SYN-ACK 报文。

此时，TCP 连接已经建立完成，可以开始传输数据。

- **第一次握手** ：Client 什么都不能确认；Server 确认了对方发送正常，自己接收正常

- **第二次握手** ：Client 确认了：自己发送、接收正常，对方发送、接收正常；Server 确认了：对方发送正常，自己接收正常

- **第三次握手** ：Client 确认了：自己发送、接收正常，对方发送、接收正常；Server 确认了：自己发送、接收正常，对方发送、接收正常

![image-20230405140718161](https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230405140718161.png)

:eyes:SYN 同步序列编号(Synchronize Sequence Numbers) 是 TCP/IP 建立连接时使用的握手信号。在客户机和服务器之间建立正常的 TCP 网络连接时，客户机首先发出一个 SYN 消息，服务器使用 SYN-ACK 应答表示接收到了这个消息，最后客户机再以 ACK(Acknowledgement）消息响应。这样在客户机和服务器之间才能建立起可靠的 TCP 连接，数据才可以在客户机和服务器之间传递。

### **TCP 四次挥手(关闭连接)**

TCP 四次挥手是关闭 TCP 连接的过程。具体步骤如下：

- **第一次挥手** ：客户端发送一个 FIN（SEQ=X） 标志的数据包->服务端，用来关闭客户端到服务器的数据传送。然后，客户端进入 **FIN-WAIT-1** 状态。

- **第二次挥手** ：服务器收到这个 FIN（SEQ=X） 标志的数据包，它发送一个 ACK （SEQ=X+1）标志的数据包->客户端 。然后，此时服务端进入**CLOSE-WAIT**状态，客户端进入**FIN-WAIT-2**状态。
  - (**二次挥手和三次挥手不能合二为一**：服务器收到客户端断开连接的请求时，可能还有一些数据没有发完，这时先回复 ACK，表示接收到了断开连接的请求。等到数据发完之后再发 FIN，断开服务器到客户端的数据传送。)
  - 如果第二次挥手时服务器的 ACK 没有送达客户端：客户端会重新发送 FIN 请求。

- **第三次挥手** ：服务端关闭与客户端的连接并发送一个 FIN (SEQ=y)标志的数据包->客户端请求关闭连接，然后，服务端进入**LAST-ACK**状态。

- **第四次挥手** ：客户端发送 ACK (SEQ=y+1)标志的数据包->服务端并且进入**TIME-WAIT**状态，服务端在收到 ACK (SEQ=y+1)标志的数据包后进入 CLOSE 状态。此时，如果客户端等待 **2MSL(报文段最长寿命)** 后依然没有收到回复，就证明服务端已正常关闭，随后，客户端也可以关闭连接了。

  - **客户端需要等待 2*MSL（报文段最长寿命）时间后才进入 CLOSED 状态：**第四次挥手时，**客户端发送给服务器的 ACK 有可能丢失，如果服务端因为某些原因而没有收到 ACK 的话，服务端就会重发 FIN**，如果客户端在 2*MSL 的时间内收到了 FIN，就会重新发送 ACK 并再次等待 2MSL，**防止 Server 没有收到 ACK 而不断重发 FIN**。

  (**MSL(Maximum Segment Lifetime)** : 一个片段在网络中最大的存活时间，2MSL 就是一个发送和一个回复所需的最大时间。如果直到 2MSL，Client 都没有再次收到 FIN，那么 Client 推断 ACK 已经被成功接收，则结束 TCP 连接。

此时，TCP 连接已经关闭完成。**只要四次挥手没有结束，客户端和服务端就可以继续传输数据！**

![image-20230405140834269](https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230405140834269.png)